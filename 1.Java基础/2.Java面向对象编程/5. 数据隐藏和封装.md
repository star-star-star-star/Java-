# 数据隐藏和封装的概念

把数据隐藏在类中，只能通过方法获取，这种技术叫做封装（encapsulation），因为它把数据（和内部方法）安全地密封在类这个“容器”中，只能由可信的用户（即这个类中的方法）访问。

进行封装最重要的原因是，隐藏类的内部实现细节。如果避免让程序员依赖这些细节，你就可以放心地修改实现，而无需担心会破坏使用这个类的现有代码。

需要注意的是，你应该始终封装自己的代码。如果没有封装好，那么几乎无法推知并最终确认代码是否正确，尤其在多线程环境中（而基本上所有Java程序都运行在多线程的环境中）。

使用封装的另外一个原因是保护类，避免有意或无意做了糊涂事。类中经常包含一些相互依赖的字段，而且这些字段的状态必须始终如一。如果允许程序员（包括你自己）直接操作这些字段，修改某个字段后可能不会修改重要的相关字段，那么类的状态就前后不一致了。然而，如果必须调用方法才能修改字段，那么这个方法可以做一切所需的措施，确保状态一致。类似地，如果类中定义的某些方法仅供内部使用，隐藏这些方法能避免这个类的用户调用这些方法。

封装还可以这样理解：把类的数据都隐藏后，方法就是在这个类的对象上能执行的唯一一种可能的操作。

只要小心测试和调试方法，就可以认为类能按预期的方式运行。然而，如果类的所有字段都可以直接操作，那么要测试的可能性根本数不完。

隐藏类的字段和方法还有一些次要的原因：
+ 如果内部字段和方法在外部可见，会弄乱类的API。让可见的字段尽量少，可以保持类的整洁，从而更易于使用和理解。
+ 如果方法对类的使用者可见，就必须为其编写文档。把方法隐藏起来，可以节省时间和精力。

# 访问控制

Java定义了一些访问控制规则，可以禁止类的成员在类外部使用。访问控制修饰符为字段或方法指定访问规则。

## 访问包

Java语言不直接支持包的访问控制。访问控制一般在类和类的成员这些层级完成。

需要注意的是，已经加载的包始终可以被同一个包中的代码访问。一个包在其他包中是否能访问，取决于这个包在宿主系统中的部署方式。例如，如果组成包的类文件存储在一个目录中，那么用户必须能访问这个目录和其中的文件才能访问包。

## 访问类

在默认情况下，顶层类在定义它的包中可以访问。不过，如果顶层类声明为public，那么在任何地方都能访问。

嵌套类是定义为其他类的成员的类。因为这种内部类是某个类的成员，因此也遵守成员的访问控制规则。

## 访问成员

类的成员在类的主体里始终可以访问。默认情况下，在定义这个类的包中也可以访问成员。这种默认的访问等级一般叫做“包访问”。这只是四个可用的访问等级中的一个，其他三个等级使用：public、private和protected修饰符定义。

下述访问规则适用于类的成员：
1. 类中的所有字段和方法在类的主体里始终可以使用。
2. 如果类的成员使用public修饰符声明，那么可以在能访问这个类的任何地方访问这个成员。这是限制最松的访问控制类型。
3. 如果类的成员声明为private，那么除了在类的内部，其他地方都不能访问这个成员。这是限制最严的访问控制类型。
4. 如果类的成员声明为protected，那么包里的所有类都能访问这个成员（等同于默认的包访问规则），而且在这个类的任何子类的主体中也能访问这个成员，而不管子类在哪个包中定义。
5. 如果声明类的成员时没有使用任何修饰符，那么使用默认的访问规则（有时叫包访问），包中的所有类都能访问这个成员，但是在包外部不能访问。需要注意的是，默认的访问规则比protected严格，因为默认规则不允许在包外部的子类中访问成员。

⭐需要特别注意的是，使用protected修饰的成员时要格外小心。假设A类使用protected声明了一个字段，而且在另一个包中定义了B类继承A类，那么，B类继承了这个protected声明的字段。在B类的代码中可以访问当前实例的这个字段，而且引用B类实例的代码也能访问这个字段。但是，这并不意味着在B类的代码中能读取任何一个A类实例的受保护字段。

## 继承中的访问控制

Java规范规定：
1. 子类继承超类中所有可以访问的实例字段和实例方法。
2. 如果子类和超类在同一个包中定义，那么子类继承所有没有使用private声明的实例字段和方法。
3. 如果子类在其他包中定义，那么它继承所有使用protected和public声明的实例字段和方法。
4. 使用private声明的字段和方法绝不会被继承；类字段和类方法也一样。
5. 构造方法不会被继承，而是链在一起调用。

需要注意的是，有些程序员似乎会对“子类不继承超类中不可访问的字段和方法”感到困惑，这似乎暗示了创建子类的实例时不会为超类中使用private声明的字段分配内存。但其实，子类的每个实例都包含一个完整的超类实例，其中包括所有不可访问的字段和方法。某些成员可能无法访问，这似乎和类的成员在类的主体中始终可以访问相矛盾。为了避免误解，我们要使用“继承的成员”表示那些可以访问的超类成员。那么，关于成员访问性的正确表述应该是：“所有继承的成员和所有在类中定义的成员都是可以访问的。”这句话还可以换种方式说：“类继承超类的所有实例字段和实例方法（但不继承构造方法）。”“在类的主体中始终可以访问这个类定义的所有字段和方法，而且还可以访问继承自超类的可访问的字段和方法。”

## ⁂summary

<table border="2">
	<tr>
		<th rowspan="2">能否访问</th>
		<th colspan="4">成员可见性</th>
	</tr>
	<tr>
		<th>public</th>
		<th>protected</th>
		<th>default</th>
		<th>private</th>
	</tr>
	<tr>
		<th>定义成员的类</th>
		<th>可见</th>
		<th>可见</th>
		<th>可见</th>
		<th>可见</th>
	</tr>
	<tr>
		<th>同一个包中的类</th>
		<th>可见</th>
		<th>可见</th>
		<th>可见</th>
		<th>不可见</th>
	</tr>
	<tr>
		<th>不同包中的子类</th>
		<th>可见</th>
		<th>可见</th>
		<th>不可见</th>
		<th>不可见</th>
	</tr>
	<tr>
		<th>不同的包，也不是子类</th>
		<th>可见</th>
		<th>不可见</th>
		<th>不可见</th>
		<th>不可见</th>
	</tr>
</table>

下面是一些使用可见性修饰符的经验法则：
1. 只使用public声明组成类的公开API的方法和常量。使用public声明的字段只能是常量和不能修改的对象，而且必须同时使用final声明。
2. 使用protected声明大多数使用这个类的程序员不会用到的字段和方法，但是在其他包中定义子类时可能会用到。严格来说，使用protected声明的成员是类公开API的一部分，必须为其编写文档，而且不能轻易修改，以防破坏依赖这些成员的代码。
3. 如果字段和方法供类的内部实现细节使用，但是同一个包中协作的类也要使用，那么就使用默认的包可见性。
4. 使用private声明只在类内部使用，在其他地方都要隐藏的字段和方法。

如果不确定该使用protected、包还是private可见性，那么先使用private。如果过于严格，可以稍微放松访问限制（如果是字段的话，还可以提供访问器方法）。

设计API时这么做尤其重要，因为提高访问限制是不向后兼容的改动，可能会破坏依赖成员访问性的代码。

# 数据访问器方法

可以有两种方法访问字段：一种是把字段本身声明为public；一种是提供public方法读写字段。

提供public方法读写字段和把字段本身声明为public不是一回事。二者的区别是，方法可以检查错误。

需要注意的是，在Java中，数据访问器方法的命名有个通用约定，即以“get”和“set”开头。但是，如果要访问的字段是boolean类型，那么读取字段的方法使用的名称可能会以“is”开头。
